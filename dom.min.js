"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),iqwerty=iqwerty||{},Component=function(){function e(){var t=this;_classCallCheck(this,e),this.$iq={template:""};var n=Array.from(Object.getOwnPropertyNames(window)),r=Object.getOwnPropertyNames(Object.getPrototypeOf(this));n.forEach(function(e){-1===r.indexOf(e)&&Object.defineProperty(t,e,{value:void 0,configurable:!0,writable:!0})})}return _createClass(e,[{key:"$iqOnMount",value:function(){}}]),e}(),DOM_PAGE_LOADED=new Promise(function(e){document.addEventListener("DOMContentLoaded",function(){e()}),"interactive"!==document.readyState&&"complete"!==document.readyState||e()});DOM_PAGE_LOADED.then(function(){iqwerty.dom.Load(document.body)}),iqwerty.dom=function(){function _toPascalCase(e){return e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}).replace(/^[a-z]/,function(e){return e.toUpperCase()})}function _templateLoader(){return function(e){return{for:function(t){return fetch(e).then(function(e){return e.text()}).then(function(e){t[IQ][IQ_MD_TPL]=e})}}}}function _saferEval(e,t){try{return new Function("\n\t\t\t\twith(this) {\n\t\t\t\t\t"+e+"\n\t\t\t\t}\n\t\t\t").call(t)}catch(n){return void console.error(n,"JavaScript couldn't be executed in the given context.\nJavaScript:\n"+e+"\nComponent context:",t)}}function _saferEvalReturn(e,t){return _saferEval("return "+e,t)}function _saferEvalTemplate(e,t){return _saferEval("return `"+e+"`",t)||""}function _saferInstantiateComponent(maybeClassName,componentElement,detector){if(!/[A-Z]/.test(maybeClassName))throw new Error('The class "'+maybeClassName+"\" doesn't seem like a valid class name. Quantum components are recommended to be in PascalCase");var loader=_templateLoader(),inject="{\n\t\t\tdetector: detector,\n\t\t\telementRef: componentElement,\n\t\t\tloadTemplate: loader,\n\t\t}",maybeCtrl=void 0;try{maybeCtrl=eval("new "+maybeClassName+"("+inject+")")}catch(e){throw console.warn('Did you remember to create the class "'+maybeClassName+'"?'),new Error(e)}if(!maybeCtrl[IQ])throw new Error('Whoops. Your component name "'+maybeClassName+'" probably conflicts with some JS reserved word.');return maybeCtrl}function _observe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};e[IQ_SYM]||(e[IQ_SYM]={}),Object.keys(e).forEach(function(n){"number"!=typeof e[n]&&"string"!=typeof e[n]&&"boolean"!=typeof e[n]&&"object"!==_typeof(e[n])&&void 0!==e[n]||e[IQ_SYM][n]!==e[n]&&(e[IQ_SYM][n]=e[n],Object.defineProperty(e,n,{get:function(){return e[IQ_SYM][n]},set:function(r){e[IQ_SYM][n]=r,t()}}),null!=e[n]&&_patchObjectMutators(e[n],t),"object"===_typeof(e[n])&&_observe(e[n],t))})}function _patchObjectMutators(e,t){var n=e.constructor.name,r=MUTATORS[n];r&&r.forEach(function(n){var r=e[n].bind(e);e[n]=function(){var n=r.apply(void 0,arguments);return t(),_observe(e,t),n}})}function _templatizeBindings(e){var t=new RegExp(BINDING,"g");return e.replace(t,"${$1}")}function _handleFor(e,t){console.log("for",e,t);var n=e.dataset[IQ_DIRECTIVE+"for"],r=n.substring(0,n.indexOf(" ")),o=_saferEval("\n\t\t\tconst out = [];\n\t\t\tfor(const "+n+") {\n\t\t\t\tout.push({\n\t\t\t\t\thtml: `"+e.outerHTML+"`,\n\t\t\t\t\tcontext: "+r+",\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn out;\n\t\t",t),a=document.createDocumentFragment();o.forEach(function(e){var n=document.createElement(IQ_CONTAINER);n.innerHTML=e.html;for(var o=n.children[0],i=[o];i.length;){var c=i.pop();c[IQ_SYM]=new Map,c[IQ_SYM].set(IQ_SYM_INPUTS,new Map),c[IQ_SYM].get(IQ_SYM_INPUTS).set(r,e.context),i.push.apply(i,_toConsumableArray(c.children))}o.removeAttribute("data-"+IQ_DIRECTIVE+"for"),t[r]=e.context,_evaluateTemplate(o,t),delete t[r],a.appendChild(n.children[0])}),e.innerHTML="";var i=!0,c=!1,l=void 0;try{for(var f,u=e.attributes[Symbol.iterator]();!(i=(f=u.next()).done);i=!0){var s=f.value,d=s.name;e.removeAttribute(d)}}catch(e){c=!0,l=e}finally{try{!i&&u.return&&u.return()}finally{if(c)throw l}}e.parentNode.replaceChild(a,e)}function _handleIf(e,t){if(console.log("if",e),!_saferEvalReturn(e.dataset[IQ_DIRECTIVE+"if"],t)){var n=document.createComment("iq.if removed node");e.parentNode.replaceChild(n,e)}}function _prepareDirectives(e,t){Object.keys(e.dataset).filter(function(e){return 0===e.indexOf(IQ_DIRECTIVE)}).forEach(function(n){var r=n.replace(IQ_DIRECTIVE,"");switch(IQ_DIRECTIVES.has(r)||(e[IQ_SYM]||(e[IQ_SYM]=new Map,e[IQ_SYM].set(IQ_SYM_INPUTS,new Map)),e[IQ_SYM].get(IQ_SYM_INPUTS).set(r,_saferEvalReturn(e.dataset[n],t))),r){case"for":_handleFor(e,t);break;case"if":_handleIf(e,t)}})}function _prepareEvents(e,t){console.log("events",e),Object.keys(e.dataset).filter(function(e){return 0===e.indexOf(IQ_EVENT)}).forEach(function(n){var r=n.replace(IQ_EVENT,"");console.log("event",r),e.addEventListener(r,function(r){console.log("event happened!",e.dataset[n]),e[IQ_SYM]&&e[IQ_SYM].get(IQ_SYM_INPUTS)&&e[IQ_SYM].get(IQ_SYM_INPUTS).forEach(function(e,n){console.log("restoring data from metadata",n,e),t[n]=e}),t[IQ_EVENT_INJECT]=r,_saferEval(e.dataset[n],t),e[IQ_SYM]&&e[IQ_SYM].get(IQ_SYM_INPUTS)&&e[IQ_SYM].get(IQ_SYM_INPUTS).forEach(function(e,n){delete t[n]}),delete t[IQ_EVENT_INJECT]})})}function _evaluateTemplate(e,t){for(var n=[e];n.length;){var r=n.pop();if(r.nodeType===Node.TEXT_NODE)r.textContent=_saferEvalTemplate(r.textContent,t);else if(r.nodeType===Node.ELEMENT_NODE){_prepareDirectives(r,t),_prepareEvents(r,t);var o=!0,a=!1,i=void 0;try{for(var c,l=r.attributes[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var f=c.value,u=f.name,s=f.value;if(-1===u.indexOf(IQ_DIRECTIVE)){var d=_saferEvalTemplate(s,t);r.getAttribute(u)!==d&&(console.log("changing attributes",r,u),r.setAttribute(u,d))}}}catch(e){a=!0,i=e}finally{try{!o&&l.return&&l.return()}finally{if(a)throw i}}}n.push.apply(n,_toConsumableArray(r.childNodes))}}function _nodeChanged(e,t){return e.nodeType!==t.nodeType||e.nodeType===Node.TEXT_NODE&&e.textContent!==t.textContent||e.tagName!==t.tagName}function _patch(e,t){var n=Array.from(e.childNodes),r=Array.from(t.childNodes);console.log(n,r);for(var o=0;n[o]||r[o];){if(n[o])if(r[o]){if(_nodeChanged(n[o],r[o]))console.log("changing!",n[o],r[o]),n[o].parentNode.replaceChild(r[o],n[o]);else if(r[o].nodeType===Node.ELEMENT_NODE){console.log("checking children"),_patch(n[o],r[o]);var a=!0,i=!1,c=void 0;try{for(var l,f=r[o].attributes[Symbol.iterator]();!(a=(l=f.next()).done);a=!0){var u=l.value,s=u.name,d=u.value;-1===s.indexOf(IQ_DIRECTIVE)&&(n[o].getAttribute(s)!==d&&(console.log("updating attributes",n[o],s),n[o].setAttribute(s,d)))}}catch(e){i=!0,c=e}finally{try{!a&&f.return&&f.return()}finally{if(i)throw c}}n[o][IQ_SYM]=r[o][IQ_SYM]}}else console.log("removing"),e.removeChild(n[o]);else console.log("appending"),e.appendChild(r[o]);o++}}function Load(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.createDocumentFragment(),n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];Array.from(e.querySelectorAll("*")).concat(e).filter(function(e){return-1!==e.tagName.indexOf("-")}).forEach(function(e){e[IQ_SYM]||(e[IQ_SYM]=new Map,e[IQ_SYM].set(IQ_SYM_INPUTS,new Map));var r=void 0;if(e[IQ_SYM].get(IQ_SYM_CTRL))r=e[IQ_SYM].get(IQ_SYM_CTRL);else{var o={ComponentShouldChange:function(){Load(e)}},a=_toPascalCase(e.tagName.toLowerCase());r=_saferInstantiateComponent(a,e,o),e[IQ_SYM].get(IQ_SYM_INPUTS).forEach(function(e,t){r[t]=e}),e[IQ_SYM].set(IQ_SYM_CTRL,r),_observe(r,function(){o.ComponentShouldChange(),console.log("observed changes happening")})}var i=_templatizeBindings(r[IQ][IQ_MD_TPL]),c=document.createElement(IQ_CONTAINER);c.innerHTML=i;var l=document.createDocumentFragment();Array.from(c.childNodes).forEach(function(e){l.appendChild(e)}),_evaluateTemplate(l,r),_patch(t,l),t.children.length&&Array.from(t.children).forEach(function(e){Load(e,e,!1)}),n&&_patch(e,t)})}var BINDING="{{(.*?)}}",IQ_SYM=Symbol("$iq"),IQ_SYM_CTRL=Symbol("controller"),IQ_SYM_INPUTS=Symbol("inputs"),IQ="$iq",IQ_MD_TPL="template",IQ_CONTAINER="iq-container",IQ_DIRECTIVE="iq.",IQ_DIRECTIVES=new Set(["for","if"]),IQ_EVENT="iq:",IQ_EVENT_INJECT="$iqEvent",MUTATORS=Object.freeze({Array:["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"],Map:["clear","delete","set"],Set:["add","clear","delete"]});return{Load:Load}}(),"undefined"!=typeof module&&(module.exports={Component:Component,dom:iqwerty.dom});